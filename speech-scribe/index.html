<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeechScribe AI | Pro Transcriber</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.5);
            --secondary: #a855f7;
            --accent: #2dd4bf;
            --bg-deep: #020617;
            --card-bg: rgba(15, 23, 42, 0.6);
            --border-light: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep);
            color: #f1f5f9;
            overflow-x: hidden;
        }

        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid var(--border-light);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .gradient-text {
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            filter: drop-shadow(0 0 20px rgba(129, 140, 248, 0.3));
        }

        .premium-border {
            position: relative;
            background: linear-gradient(var(--bg-deep), var(--bg-deep)) padding-box,
                linear-gradient(135deg, var(--primary), var(--secondary)) border-box;
            border: 1px solid transparent;
        }

        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px) rotate(0deg);
            }

            50% {
                transform: translateY(-20px) rotate(2deg);
            }
        }

        @keyframes word-pop {
            0% {
                opacity: 0;
                transform: translateY(10px) scale(0.9);
                filter: blur(4px);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
                filter: blur(0);
            }
        }

        .word-reveal {
            display: inline-block;
            animation: word-pop 0.5s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .mesh-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(45, 212, 191, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(99, 102, 241, 0.15) 0px, transparent 50%);
            background-color: var(--bg-deep);
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
            pointer-events: none;
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://grainy-gradients.vercel.app/noise.svg');
            opacity: 0.05;
            z-index: -1;
            pointer-events: none;
            filter: contrast(150%) brightness(150%);
        }

        .wave-bar {
            width: 4px;
            background: var(--primary);
            border-radius: 2px;
            box-shadow: 0 0 10px var(--primary-glow);
            animation: waveform 1.2s ease-in-out infinite;
        }

        @keyframes waveform {

            0%,
            100% {
                height: 8px;
                transform: scaleY(1);
            }

            50% {
                height: 40px;
                transform: scaleY(1.5);
            }
        }

        .glow-pulse {
            animation: glow-pulse 2s infinite;
        }

        @keyframes glow-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }

        .neon-border {
            border: 1px solid var(--border-light);
            transition: all 0.3s ease;
        }

        .neon-border:hover {
            border-color: var(--primary);
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .active-mode {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 20px var(--primary-glow), inset 0 0 10px var(--primary-glow);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .game-hud {
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .scanline {
            width: 100%;
            height: 2px;
            background: rgba(99, 102, 241, 0.1);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 5;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% {
                transform: translateY(0);
            }

            100% {
                transform: translateY(100vh);
            }
        }

        @keyframes progress {
            0% {
                width: 0%;
                left: 0;
            }

            50% {
                width: 100%;
                left: 0;
            }

            100% {
                width: 0%;
                left: 100%;
            }
        }

        .progress-liquid {
            position: relative;
            overflow: hidden;
        }

        .progress-liquid::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, transparent, var(--primary), transparent);
            animation: progress 2s infinite linear;
        }

        .monitor-pulse {
            position: relative;
        }

        .monitor-pulse::before {
            content: '';
            position: absolute;
            inset: -20px;
            border: 2px solid var(--accent);
            border-radius: 50%;
            animation: monitor-ping 2s cubic-bezier(0, 0, 0.2, 1) infinite;
            opacity: 0;
        }

        @keyframes monitor-ping {
            0% {
                transform: scale(0.5);
                opacity: 0.8;
            }

            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
    </style>


</head>

<body class="selection:bg-indigo-500/30">
    <!-- Premium Background System -->
    <div class="mesh-bg"></div>
    <div class="grid-overlay"></div>
    <div class="noise-overlay"></div>
    <div class="scanline opacity-[0.03]"></div>

    <div x-data="scribeApp()"
        class="max-w-7xl mx-auto py-8 px-4 md:py-12 md:px-6 min-h-screen flex flex-col justify-center relative z-10 transition-all duration-300">
        <header class="text-center mb-8 md:mb-16 transition-all duration-700"
            :class="transcript && 'scale-90 opacity-80'">
            <div
                class="inline-flex items-center gap-2 px-5 py-2 mb-8 text-[11px] font-black tracking-[0.4em] text-indigo-300 uppercase bg-indigo-500/10 border border-indigo-500/20 rounded-full backdrop-blur-md animate-pulse">
                <span class="relative flex h-2.5 w-2.5">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                    <span
                        class="relative inline-flex rounded-full h-2.5 w-2.5 bg-indigo-500 shadow-[0_0_10px_#6366f1]"></span>
                </span>
                Pro Transcription Hub
            </div>
            <h1 class="text-5xl md:text-7xl lg:text-9xl font-black mb-4 md:mb-6 tracking-tighter leading-none">
                <span class="gradient-text">Speech</span><span class="text-white">Scribe</span>
            </h1>
            <p class="text-slate-400 text-base md:text-xl max-w-2xl mx-auto leading-relaxed font-medium">
                Elevate your raw audio into <span class="text-indigo-400 font-bold">intelligent text</span>.
                Experience seamless fusion of AI & Interactive design.
            </p>
            <div class="mt-8 flex justify-center items-center gap-2 text-slate-500 text-xs md:text-sm font-semibold">
                <span>Made with <span class="text-rose-500">‚ù§Ô∏è</span> by</span>
                <a href="https://spinotek.com" target="_blank"
                    class="px-3 py-1 bg-white/5 border border-white/10 rounded-lg text-white hover:text-indigo-400 hover:border-indigo-500/50 transition-all no-underline">
                    Spinotek
                </a>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8 items-stretch justify-center transition-all duration-700">
            <!-- Main Card System (Hidden during Monitoring or Monitor Review) -->
            <div x-show="(status === 'idle' || (status === 'complete' && processMode !== 'monitor') || processMode === 'manual') && status !== 'monitoring'"
                class="glass rounded-[2rem] md:rounded-[3rem] overflow-hidden flex flex-col transition-all duration-700 active-shadow min-h-0"
                :class="(transcript || showResultCard) ? 'lg:w-[60%]' : 'max-w-4xl mx-auto w-full group/main'">


                <template x-if="status === 'idle'">
                    <div class="relative">
                        <div class="grid lg:grid-cols-5 gap-0">
                            <!-- Left: Feature Intel -->
                            <div
                                class="lg:col-span-2 bg-white/5 p-10 border-r border-white/5 hidden lg:flex flex-col gap-8">
                                <div
                                    class="p-8 bg-white/5 rounded-[2.5rem] border border-white/5 hover:border-indigo-500/30 hover:bg-white/10 transition-all duration-500 group/feat">
                                    <div
                                        class="w-14 h-14 bg-indigo-500/20 rounded-2xl flex items-center justify-center text-2xl mb-6 shadow-[0_0_20px_rgba(99,102,241,0.2)] group-hover/feat:scale-110 transition-transform">
                                        üöÄ</div>
                                    <h4 class="font-bold text-white text-lg mb-2">Ultra Fast</h4>
                                    <p class="text-sm text-slate-400 leading-relaxed font-medium">Powered by Groq LPU
                                        engine for
                                        sub-second processing.</p>
                                </div>
                                <div
                                    class="p-8 bg-white/5 rounded-[2.5rem] border border-white/5 hover:border-emerald-500/30 hover:bg-white/10 transition-all duration-500 group/feat">
                                    <div
                                        class="w-14 h-14 bg-emerald-500/20 rounded-2xl flex items-center justify-center text-2xl mb-6 shadow-[0_0_20px_rgba(16,185,129,0.2)] group-hover/feat:scale-110 transition-transform">
                                        üéØ</div>
                                    <h4 class="font-bold text-white text-lg mb-2">High Precision</h4>
                                    <p class="text-sm text-slate-400 leading-relaxed font-medium">Whisper Large V3
                                        ensures
                                        peak transcription accuracy.</p>
                                </div>
                                <div
                                    class="p-8 bg-white/5 rounded-[2.5rem] border border-white/5 hover:border-purple-500/30 hover:bg-white/10 transition-all duration-500 group/feat">
                                    <div
                                        class="w-14 h-14 bg-purple-500/20 rounded-2xl flex items-center justify-center text-2xl mb-6 shadow-[0_0_20px_rgba(168,85,247,0.2)] group-hover/feat:scale-110 transition-transform">
                                        üïπÔ∏è</div>
                                    <h4 class="font-bold text-white text-lg mb-2">Interactive</h4>
                                    <p class="text-sm text-slate-400 leading-relaxed font-medium">Engage with immersive
                                        environments while we work.</p>
                                </div>
                            </div>

                            <!-- Right: Upload Form -->
                            <div class="lg:col-span-3 p-6 md:p-12 flex flex-col justify-center">
                                <div class="mb-10 group">
                                    <div class="flex items-center justify-between mb-4 px-2">
                                        <label
                                            class="block text-[11px] font-black text-slate-500 uppercase tracking-[0.4em]">Intelligence
                                            Layer</label>
                                        <div class="flex gap-1.5 bg-white/5 p-1 rounded-2xl border border-white/5">
                                            <button
                                                @click="apiMode = 'system'; groqKey = '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'"
                                                :class="apiMode === 'system' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/20' : 'text-slate-500 hover:text-slate-300'"
                                                class="px-4 py-2 text-[10px] font-black uppercase rounded-xl transition-all">Shared</button>
                                            <button
                                                @click="apiMode = 'custom'; groqKey = (localStorage.getItem('groq_key_custom') || '')"
                                                :class="apiMode === 'custom' ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-600/20' : 'text-slate-500 hover:text-slate-300'"
                                                class="px-4 py-2 text-[10px] font-black uppercase rounded-xl transition-all">Custom</button>
                                        </div>
                                    </div>

                                    <div x-show="apiMode === 'custom'" x-transition.opacity
                                        class="relative group/input">
                                        <input type="password" x-model="groqKey"
                                            @input="localStorage.setItem('groq_key_custom', groqKey)"
                                            placeholder="Enter Groq API Key..."
                                            class="w-full bg-white/5 border border-white/5 rounded-[1.5rem] px-6 py-5 text-sm font-mono text-indigo-300 placeholder:text-slate-600 focus:bg-white/10 focus:border-indigo-500/50 transition-all outline-none">
                                        <div
                                            class="absolute right-6 top-5 text-lg opacity-40 group-hover/input:opacity-100 transition-opacity">
                                            üîë</div>
                                    </div>

                                    <div x-show="apiMode === 'system'" x-transition.opacity
                                        class="p-5 bg-indigo-500/10 border border-indigo-500/20 rounded-[1.5rem] text-[12px] text-indigo-300 font-bold flex items-center gap-4">
                                        <div
                                            class="w-8 h-8 rounded-xl bg-indigo-500/20 flex items-center justify-center text-lg">
                                            ‚ú®</div>
                                        Active Groq Engine ready for processing.
                                    </div>
                                </div>

                                <div class="mb-12">
                                    <label
                                        class="block text-[11px] font-black text-slate-500 uppercase tracking-[0.4em] mb-6 px-2">Select
                                        Pipeline</label>
                                    <div class="grid grid-cols-3 gap-3 md:gap-5">
                                        <div @click="processMode = 'auto'"
                                            :class="processMode === 'auto' ? 'active-mode' : 'bg-white/5 border-white/5'"
                                            class="p-6 rounded-[2.5rem] border-2 cursor-pointer transition-all hover:bg-white/10 group flex flex-col items-center gap-4 text-center">
                                            <div
                                                class="w-14 h-14 rounded-2xl bg-indigo-500/10 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform shadow-[0_0_15px_rgba(99,102,241,0.2)]">
                                                ‚ö°</div>
                                            <div>
                                                <h4 class="text-xs font-black text-white uppercase tracking-widest">Fast
                                                    Mode</h4>
                                                <p class="text-[9px] text-indigo-400 font-black mt-1">INSTANT RESULT</p>
                                            </div>
                                        </div>
                                        <div @click="processMode = 'manual'"
                                            :class="processMode === 'manual' ? 'active-mode' : 'bg-white/5 border-white/5'"
                                            class="p-6 rounded-[2.5rem] border-2 cursor-pointer transition-all hover:bg-white/10 group flex flex-col items-center gap-4 text-center">
                                            <div
                                                class="w-14 h-14 rounded-2xl bg-amber-500/10 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform shadow-[0_0_15px_rgba(245,158,11,0.2)]">
                                                üèéÔ∏è</div>
                                            <div>
                                                <h4 class="text-xs font-black text-white uppercase tracking-widest">
                                                    Adventure</h4>
                                                <p class="text-[8px] text-amber-400 font-black mt-1">STREAM & GAMING</p>
                                            </div>
                                        </div>
                                        <div @click="processMode = 'monitor'"
                                            :class="processMode === 'monitor' ? 'active-mode border-rose-500/50' : 'bg-white/5 border-white/5'"
                                            class="p-6 rounded-[2.5rem] border-2 cursor-pointer transition-all hover:bg-white/10 group flex flex-col items-center gap-4 text-center">
                                            <div
                                                class="w-14 h-14 rounded-2xl bg-rose-500/10 flex items-center justify-center text-3xl group-hover:scale-110 transition-transform shadow-[0_0_15px_rgba(244,63,94,0.2)]">
                                                üì°</div>
                                            <div>
                                                <h4 class="text-xs font-black text-white uppercase tracking-widest">
                                                    Monitor</h4>
                                                <p class="text-[9px] text-rose-400 font-black mt-1">RECOGNITION</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>


                                <!-- Upload Gateway -->
                                <div x-show="processMode !== 'monitor'" @click="$refs.fileInput.click()"
                                    class="group/upload relative border-2 border-dashed border-white/5 rounded-[2rem] md:rounded-[3rem] p-10 md:p-20 text-center hover:border-indigo-500/50 hover:bg-white/5 transition-all duration-500 cursor-pointer overflow-hidden">
                                    <input type="file" x-ref="fileInput" class="hidden" accept="audio/*"
                                        @change="handleFile($event)">

                                    <div class="relative z-10">
                                        <div class="animate-float inline-block mb-6 md:mb-10 relative">
                                            <div
                                                class="text-6xl md:text-8xl group-hover/upload:scale-110 group-hover/upload:rotate-3 transition-all duration-700 drop-shadow-[0_0_30px_rgba(99,102,241,0.4)]">
                                                üéôÔ∏è</div>
                                            <div
                                                class="absolute -top-2 -right-2 w-5 h-5 md:w-7 md:h-7 bg-indigo-500 rounded-full border-4 border-slate-900 shadow-[0_0_15px_#6366f1] animate-pulse">
                                            </div>
                                        </div>
                                        <h3
                                            class="text-xl md:text-3xl font-black mb-2 md:mb-4 text-white tracking-tight">
                                            Ingest Audio
                                            Source</h3>
                                        <p class="text-slate-500 text-sm md:text-base font-medium">Click anywhere or
                                            drag & drop
                                            high-fidelity audio</p>
                                    </div>

                                    <!-- Decorative Corner -->
                                    <div
                                        class="absolute top-0 right-0 p-6 opacity-20 group-hover/upload:opacity-100 transition-opacity">
                                        <div class="w-12 h-12 border-t-2 border-r-2 border-indigo-500 rounded-tr-2xl">
                                        </div>
                                    </div>
                                </div>

                                <!-- Monitor Gateway -->
                                <div x-show="processMode === 'monitor'" @click="startMonitoring()"
                                    class="group/monitor relative border-2 border-dashed border-rose-500/20 rounded-[2rem] md:rounded-[3rem] p-10 md:p-20 text-center hover:border-rose-500/50 hover:bg-rose-500/5 transition-all duration-500 cursor-pointer overflow-hidden">
                                    <div class="relative z-10">
                                        <div class="animate-float inline-block mb-6 md:mb-10 relative">
                                            <div
                                                class="text-6xl md:text-8xl group-hover/monitor:scale-110 group-hover/monitor:rotate-3 transition-all duration-700 drop-shadow-[0_0_30px_rgba(244,63,94,0.4)]">
                                                üì°</div>
                                            <div
                                                class="absolute -top-2 -right-2 w-5 h-5 md:w-7 md:h-7 bg-rose-500 rounded-full border-4 border-slate-900 shadow-[0_0_15px_#f43f5e] animate-pulse">
                                            </div>
                                        </div>
                                        <h3
                                            class="text-xl md:text-3xl font-black mb-2 md:mb-4 text-white tracking-tight">
                                            Active
                                            Surveillance</h3>
                                        <p class="text-slate-500 text-sm md:text-base font-medium">Capture & stream
                                            internal system
                                            audio live</p>
                                    </div>
                                </div>


                                <div
                                    class="mt-10 flex items-center justify-between text-[11px] font-black text-slate-600 uppercase tracking-[0.4em] px-4">
                                    <span class="flex items-center gap-2 mb-1">
                                        <div class="w-1.5 h-1.5 rounded-full bg-slate-700"></div>
                                        MP3 ‚Ä¢ WAV ‚Ä¢ M4A
                                    </span>
                                    <span class="flex items-center gap-3">
                                        SECURE PROTOCOL
                                        <span
                                            class="w-1.5 h-1.5 bg-emerald-500 rounded-full shadow-[0_0_8px_#10b981]"></span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <template x-if="status === 'monitoring'">
                    <div
                        class="p-8 md:p-16 text-center flex flex-col items-center justify-center min-h-[350px] md:min-h-[500px] animate-fadeIn">
                        <div
                            class="relative w-32 h-32 md:w-56 md:h-56 mb-10 md:mb-16 monitor-pulse flex items-center justify-center">
                            <div class="absolute inset-0 bg-rose-500/10 rounded-full animate-ping"></div>
                            <div class="absolute inset-8 bg-rose-500/20 rounded-full animate-pulse"></div>
                            <div
                                class="relative w-20 h-20 md:w-32 md:h-32 bg-rose-500 rounded-[1.5rem] md:rounded-[2.5rem] flex items-center justify-center text-4xl md:text-6xl shadow-[0_0_50px_rgba(244,63,94,0.6)] border-4 border-white/20">
                                üì°
                            </div>
                        </div>
                        <h2
                            class="text-3xl md:text-5xl font-black text-white italic mb-4 md:mb-6 uppercase tracking-tighter">
                            Monitoring
                            Active</h2>
                        <p
                            class="text-slate-400 font-medium mb-8 md:mb-12 max-w-md mx-auto leading-relaxed text-sm md:text-base">
                            Interpreting live signal transmission from system audio. Output is being generated in
                            real-time.
                        </p>

                        <div class="flex gap-6">
                        </div>
                    </div>
                </template>




                <template x-if="status === 'processing' || status === 'gameover'">
                    <div
                        class="relative overflow-hidden rounded-[2.5rem] bg-slate-950 aspect-[16/10] sm:aspect-[16/9] game-screen">

                        <!-- Advanced Loading State (Fast Mode) -->
                        <div x-show="processMode === 'auto' && !transcript"
                            class="absolute inset-0 z-50 bg-[#020617] flex flex-col items-center justify-center overflow-hidden">

                            <div class="relative z-10 flex flex-col items-center">
                                <!-- Audio Processor Animation -->
                                <div
                                    class="relative w-56 h-56 flex items-center justify-center bg-white/5 rounded-[3.5rem] border border-white/10 backdrop-blur-3xl p-10 mb-10 glow-pulse">
                                    <div class="flex items-end gap-2 h-16">
                                        <div class="wave-bar" style="animation-delay: 0.0s"></div>
                                        <div class="wave-bar" style="animation-delay: 0.1s"></div>
                                        <div class="wave-bar" style="animation-delay: 0.2s"></div>
                                        <div class="wave-bar" style="animation-delay: 0.3s"></div>
                                        <div class="wave-bar" style="animation-delay: 0.4s"></div>
                                        <div class="wave-bar" style="animation-delay: 0.5s"></div>
                                    </div>
                                    <div
                                        class="absolute -top-6 -right-6 w-16 h-16 bg-indigo-600 rounded-2xl flex items-center justify-center text-3xl shadow-[0_0_30px_rgba(99,102,241,0.5)] animate-bounce border-2 border-white/20">
                                        ü§ñ</div>
                                </div>

                                <div class="text-center space-y-6">
                                    <h2 class="text-4xl font-black text-white italic tracking-tighter uppercase">
                                        Neural Decoding</h2>
                                    <div class="flex flex-col items-center gap-2">
                                        <div
                                            class="h-1.5 w-64 bg-white/5 rounded-full overflow-hidden border border-white/5 progress-liquid">
                                        </div>
                                        <p
                                            class="text-indigo-400 font-black text-[11px] uppercase tracking-[0.5em] animate-pulse mt-6">
                                            GROQ LPU ENGINE ‚Ä¢ ACTIVE</p>
                                    </div>

                                    <!-- Stepper Info -->
                                    <div class="flex gap-6 mt-10 opacity-30">
                                        <div class="flex items-center gap-3">
                                            <div class="w-2 h-2 rounded-full bg-white"></div><span
                                                class="text-[9px] font-black text-white uppercase tracking-widest">INGEST</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="w-2 h-2 rounded-full bg-indigo-500 glow-pulse"></div><span
                                                class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">DECODE</span>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <div class="w-2 h-2 rounded-full bg-white"></div><span
                                                class="text-[9px] font-black text-white uppercase tracking-widest">RESOLVE</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <style>
                            @keyframes progress {
                                0% {
                                    width: 0%;
                                }

                                50% {
                                    width: 70%;
                                }

                                100% {
                                    width: 100%;
                                }
                            }
                        </style>

                        <!-- Game & Manual Mode -->
                        <div x-show="processMode === 'manual'" class="absolute inset-0" x-init="initGame()">
                            <!-- Game HUD -->
                            <div
                                class="absolute top-4 left-4 right-4 md:top-8 md:left-8 md:right-8 flex justify-between items-start z-10 game-hud">
                                <div class="space-y-2 md:space-y-3">
                                    <div
                                        class="bg-black/40 backdrop-blur-xl px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl border border-white/10 shadow-[0_0_20px_rgba(0,0,0,0.5)]">
                                        <span
                                            class="text-[6px] md:text-[10px] block font-black text-indigo-400 tracking-[0.3em]">TELEMETRY
                                            SCORE</span>
                                        <span class="text-xl md:text-3xl font-black text-white italic tracking-tight"
                                            x-text="gameScore">0</span>
                                    </div>
                                    <div
                                        class="bg-black/40 backdrop-blur-xl px-4 py-2 md:px-6 md:py-3 rounded-xl md:rounded-2xl border border-white/10 shadow-[0_0_20px_rgba(0,0,0,0.5)]">
                                        <span
                                            class="text-[6px] md:text-[10px] block font-black text-yellow-500 tracking-[0.3em]">REWARDS</span>
                                        <span class="text-xl md:text-3xl font-black text-white italic tracking-tight"
                                            x-text="gameCoins">0</span>
                                    </div>
                                </div>

                                <!-- Mode & Audio Status Indicators -->
                                <div class="flex flex-col gap-3 items-end">
                                    <div
                                        class="flex items-center gap-3 px-5 py-2 rounded-xl bg-black/40 backdrop-blur-md border border-white/10 shadow-2xl">
                                        <div class="w-2.5 h-2.5 rounded-full shadow-[0_0_10px_rgba(255,255,255,0.5)]"
                                            :class="isManual ? 'bg-amber-500' : 'bg-emerald-500'"></div>
                                        <span
                                            class="text-[6px] lg:text-[10px] font-black text-white tracking-[0.2em] uppercase"
                                            x-text="isManual ? 'Manual Control' : 'Auto-Processing'"></span>
                                    </div>

                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-5 h-5 rounded-full bg-indigo-500/20 border border-indigo-500/30 flex items-center justify-center">
                                            <div
                                                class="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_15px_rgba(99,102,241,0.8)]">
                                            </div>
                                        </div>
                                        <div class="hidden md:block px-6 py-2.5 rounded-full border border-white/10 bg-black/40 backdrop-blur-md text-[6px] lg:text-[10px] font-black uppercase tracking-[0.3em] text-white/90"
                                            x-text="isSyncing ? 'SYNCING SIGNAL...' : 'LIVE FEED ACTIVE'">
                                        </div>
                                    </div>
                                </div>

                                <div class="flex gap-2 md:gap-3">
                                    <button @click="toggleMute()"
                                        class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-black/40 backdrop-blur-xl border border-white/10 flex items-center justify-center text-lg md:text-xl hover:bg-indigo-600 transition-all shadow-2xl">
                                        <span x-text="isMuted ? 'üîá' : 'üîä'"></span>
                                    </button>
                                    <button @click="togglePause()"
                                        class="w-10 h-10 md:w-14 md:h-14 rounded-xl md:rounded-2xl bg-black/40 backdrop-blur-xl border border-white/10 flex items-center justify-center text-lg md:text-xl hover:bg-indigo-600 transition-all shadow-2xl">
                                        <span x-text="isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è'"></span>
                                    </button>
                                </div>
                            </div>

                            <canvas id="gameCanvas" class="w-full h-full cursor-crosshair touch-none"></canvas>

                            <!-- Pause Overlay -->
                            <template x-if="isPaused">
                                <div
                                    class="absolute inset-0 z-20 bg-slate-950/60 backdrop-blur-sm flex items-center justify-center">
                                    <div class="text-center">
                                        <h2 class="text-4xl font-black text-white italic mb-6 tracking-tighter">PAUSED
                                        </h2>
                                        <button @click="togglePause()"
                                            class="px-8 py-3 bg-indigo-600 text-white rounded-2xl font-bold hover:scale-105 transition-transform">RESUME
                                            GAME</button>
                                    </div>
                                </div>
                            </template>

                            <!-- Tutorials -->
                            <div
                                class="absolute bottom-6 left-1/2 -translate-x-1/2 text-white/30 text-[5px] lg:text-[10px] font-bold tracking-widest pointer-events-none text-center">
                                <div>ENJOY THE RIDE WHILE WE TRANSCRIBE</div>
                                <div class="mt-1 opacity-50">USE ARROW KEYS OR WASD TO MOVE</div>
                            </div>

                            <!-- Flash/FX -->

                            <div id="gameFlash"
                                class="absolute inset-0 bg-white opacity-0 pointer-events-none z-30 transition-opacity duration-300">
                            </div>

                            <!-- Mobile Controls -->
                            <div
                                class="absolute bottom-4 left-0 right-0 flex justify-between px-6 z-20 md:hidden pointer-events-none">
                                <div class="w-16 h-16 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center pointer-events-auto active:scale-95 transition-transform"
                                    @touchstart.prevent="window.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowLeft'}))"
                                    @mousedown.prevent="window.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowLeft'}))">
                                    ‚¨ÖÔ∏è
                                </div>
                                <div class="w-16 h-16 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center pointer-events-auto active:scale-95 transition-transform"
                                    @touchstart.prevent="window.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowRight'}))"
                                    @mousedown.prevent="window.dispatchEvent(new KeyboardEvent('keydown', {key: 'ArrowRight'}))">
                                    ‚û°Ô∏è
                                </div>
                            </div>

                            <!-- Game Over Overlay -->
                            <template x-if="status === 'gameover'">
                                <div
                                    class="absolute inset-0 z-40 bg-red-950/80 backdrop-blur-md flex items-center justify-center animate-fadeIn">
                                    <div class="text-center p-8 bg-black/40 rounded-[3rem] border border-red-500/30">
                                        <h2 class="text-5xl font-black text-white italic mb-2 tracking-tighter">GAME
                                            OVER</h2>
                                        <p class="text-red-400 font-bold mb-8 uppercase tracking-widest">Wasted! Tabrak
                                            rintangan...</p>
                                        <button @click="retryGame()"
                                            class="px-10 py-4 bg-white text-black rounded-2xl font-black hover:scale-105 transition-all active:scale-95 shadow-[0_0_30px_rgba(255,255,255,0.3)]">
                                            TRY AGAIN
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>

            <template x-if="(transcript || showResultCard) && (status !== 'complete' || processMode === 'monitor')">

                <div :class="processMode === 'monitor' ? 'lg:w-full max-w-4xl mx-auto' : (processMode === 'auto' ? 'lg:w-[60%] mx-auto' : 'lg:w-[40%]')"
                    class="flex flex-col slide-in-top h-full min-h-0 w-full mt-6 lg:mt-0">
                    <div
                        class="glass rounded-[2rem] md:rounded-[3rem] p-6 md:p-8 flex flex-col h-full bg-white/[0.03] border border-white/5 shadow-2xl overflow-hidden relative">
                        <!-- Mini Radar Pulse (Only for monitoring) -->
                        <div x-show="status === 'monitoring'"
                            class="absolute top-6 right-6 md:top-10 md:right-10 flex items-center justify-center w-8 h-8">
                            <div class="absolute inset-0 bg-rose-500/20 rounded-full animate-ping"></div>
                            <div class="absolute inset-1 bg-rose-500/40 rounded-full animate-pulse"></div>
                            <div class="relative w-4 h-4 bg-rose-600 rounded-full shadow-[0_0_10px_#f43f5e]"></div>
                        </div>
                        <div class="flex items-center justify-between mb-8">
                            <div class="flex flex-col">
                                <span class="text-[11px] font-black tracking-[0.3em]"
                                    :class="status === 'monitoring' ? 'text-rose-400' : 'text-indigo-400'"
                                    x-text="status === 'monitoring' ? '‚óè LIVE TELEMETRY' : (transcript ? 'DATA RESOLVED' : 'DECODING...')"></span>
                                <h3 class="text-2xl font-black text-white italic tracking-tight"
                                    x-text="fileName || 'INTELLIGENCE'">
                                </h3>
                            </div>
                            <div :class="status === 'monitoring' ? 'bg-rose-600 shadow-rose-600/30' : 'bg-indigo-600 shadow-indigo-600/30'"
                                class="w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-lg animate-bounce border border-white/20">
                                <span x-text="status === 'monitoring' ? 'üì°' : '‚ú®'"></span>
                            </div>

                        </div>

                        <div x-show="audioUrl"
                            class="mb-8 p-5 bg-white/5 rounded-[2rem] border border-white/5 flex items-center gap-6">
                            <div class="flex-1">
                                <audio :src="audioUrl" @timeupdate="currentTime = $event.target.currentTime" controls
                                    class="w-full h-8 accent-indigo-500 rounded-lg"></audio>
                            </div>
                            <div
                                class="text-[10px] font-black text-slate-500 uppercase tracking-widest hidden md:block">
                                SOURCE FEED</div>
                        </div>

                        <div x-ref="scrollBox"
                            x-init="$watch('currentTime', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) }); $watch('segments.length', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) })"
                            class="flex-1 h-[250px] max-h-[250px] min-h-0 bg-black/20 rounded-[2.5rem] p-8 border border-white/5 mb-8 overflow-y-auto relative group/res flex flex-wrap content-start gap-x-2 gap-y-1.5">


                            <template x-if="processMode === 'auto' && !transcript">
                                <div class="h-56">
                                    <div
                                        class="absolute inset-0 w-full h-full flex flex-col items-center justify-center bg-indigo-950/20 backdrop-blur-sm rounded-[2rem] border border-dashed border-indigo-500/20 z-10">
                                        <div class="flex items-end gap-2 h-14 mb-8">
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                            <div class="wave-bar"></div>
                                        </div>
                                        <p
                                            class="text-indigo-400 font-black text-xs uppercase tracking-[0.4em] animate-pulse">
                                            Synthesizing Result...</p>
                                    </div>
                                </div>
                            </template>

                            <template x-if="processMode === 'manual' && isSyncing && !displayedTranscript">
                                <div class="flex flex-col items-center justify-center py-16 text-indigo-400">
                                    <div
                                        class="w-12 h-12 border-2 border-indigo-500/20 border-t-indigo-500 rounded-full animate-spin mb-6">
                                    </div>
                                    <p class="text-[11px] font-black uppercase tracking-[0.3em] animate-pulse italic">
                                        ‚ú® AI Data Stream Syncing...</p>
                                </div>
                            </template>

                            <template
                                x-for="(seg, idx) in segments.filter(s => processMode === 'monitor' || currentTime >= s.start)"
                                :key="idx">
                                <span class="text-slate-300 leading-relaxed font-medium text-lg word-reveal"
                                    x-text="seg.text"></span>
                            </template>

                            <p x-show="!segments.length && transcript" x-text="transcript"
                                class="whitespace-pre-wrap transition-opacity duration-300 text-slate-300 leading-relaxed font-medium text-lg w-full"
                                :class="isSyncing ? 'opacity-40' : 'opacity-100'"></p>

                            <template
                                x-if="processMode === 'manual' && !isSyncing && !displayedTranscript && segments.length === 0 && !transcript">
                                <div class="py-16 text-center text-slate-600 text-sm italic font-medium w-full">
                                    Awaiting audio signature...
                                </div>
                            </template>
                        </div>

                        <div class="grid gap-4"
                            :class="(processMode === 'auto' || status === 'monitoring') ? 'grid-cols-2' : 'grid-cols-1'">
                            <button x-show="processMode === 'auto'" @click="status = 'complete'"
                                class="py-5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-[1.5rem] font-black text-xs shadow-xl shadow-indigo-600/20 transition-all active:scale-95 uppercase tracking-[0.2em] border border-white/10">
                                Expand Intelligence
                            </button>
                            <button @click="copyToClipboard()"
                                class="py-5 bg-white/5 border border-white/10 text-white font-black text-xs transition-all hover:bg-white/10 rounded-[1.5rem] uppercase tracking-[0.2em]"
                                x-text="copyLabel">
                            </button>
                        </div>
                        <button @click="reset()"
                            class="mt-4 w-full py-5 bg-slate-800 hover:bg-slate-700 text-white rounded-[1.5rem] font-black text-xs transition-all active:scale-95 uppercase tracking-[0.2em] border border-white/5">
                            New Ingestion
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Full View (Complete Status - Only for Auto & Manual) -->
        <template x-if="status === 'complete' && processMode !== 'monitor'">

            <div
                class="max-w-5xl mx-auto w-full animate-fadeIn p-6 md:p-8 glass rounded-[2rem] md:rounded-[3.5rem] border border-white/10 shadow-3xl">
                <div
                    class="flex flex-col md:flex-row items-center justify-between mb-8 md:mb-12 pb-8 border-b border-white/5 gap-6">
                    <div class="flex items-center gap-6 md:gap-8 w-full md:w-auto">
                        <button @click="reset()"
                            class="w-12 h-12 md:w-14 md:h-14 bg-white/5 border border-white/10 rounded-2xl flex items-center justify-center text-white hover:text-indigo-400 hover:bg-white/10 transition-all font-bold text-xl">
                            ‚Üê
                        </button>
                        <div class="flex-1 md:flex-auto">
                            <span
                                class="text-[9px] md:text-[11px] font-black text-indigo-400 tracking-[0.4em] block uppercase mb-1">DATA
                                ARCHIVE</span>
                            <h2 class="text-2xl md:text-3xl font-black text-white italic tracking-tight truncate max-w-[200px] md:max-w-md"
                                x-text="fileName || 'Untitled Feed'"></h2>
                        </div>
                    </div>
                    <div class="flex gap-4 w-full md:w-auto">
                        <button @click="copyToClipboard()"
                            class="flex-1 md:flex-none px-6 md:px-10 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs md:text-sm transition-all hover:scale-105 active:scale-95 shadow-2xl shadow-indigo-600/30 border border-white/10"
                            x-text="copyLabel">
                        </button>
                    </div>
                </div>

                <!-- Fast Mode & Monitor Mode Full View -->
                <template x-if="processMode === 'auto' || processMode === 'monitor'">

                    <div>
                        <div class="relative group/text">
                            <div
                                class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-[2.5rem] blur opacity-5 group-hover/text:opacity-20 transition duration-1000">
                            </div>
                            <textarea x-model="transcript" readonly
                                class="relative w-full h-[400px] md:h-[550px] p-8 md:p-12 bg-black/40 border border-white/5 rounded-[1.5rem] md:rounded-[2.5rem] text-base md:text-xl leading-relaxed text-slate-300 focus:outline-none ring-0 scrollbar-hide font-medium"></textarea>
                        </div>
                    </div>
                </template>

                <!-- Adventure Mode Full View (Music & Lyrics) -->
                <template x-if="processMode === 'manual'">
                    <div class="space-y-8">
                        <!-- Adventure Stats Row -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div
                                class="bg-white/5 p-8 rounded-[2.5rem] border border-white/5 flex flex-col items-center justify-center group/stat hover:bg-white/10 transition-all">
                                <span
                                    class="text-[11px] font-black text-indigo-400 tracking-[0.3em] mb-4 uppercase">MISSION
                                    SCORE</span>
                                <h4 class="text-4xl font-black text-white italic tracking-tight group-hover/stat:scale-110 transition-transform"
                                    x-text="gameScore.toLocaleString()"></h4>
                            </div>
                            <div
                                class="bg-white/5 p-8 rounded-[2.5rem] border border-white/5 flex flex-col items-center justify-center group/stat hover:bg-white/10 transition-all">
                                <span
                                    class="text-[11px] font-black text-yellow-500 tracking-[0.3em] mb-4 uppercase">REWARDS
                                    EARNED</span>
                                <h4 class="text-4xl font-black text-white italic tracking-tight group-hover/stat:scale-110 transition-transform"
                                    x-text="gameCoins"></h4>
                            </div>
                            <div class="bg-indigo-600 p-8 rounded-[2.5rem] shadow-2xl shadow-indigo-600/20 flex flex-col items-center justify-center cursor-pointer hover:bg-indigo-500 transition-all active:scale-95 group/replay"
                                @click="retryGame()">
                                <h4
                                    class="text-xl font-black text-white italic group-hover/replay:scale-110 transition-transform">
                                    REPLAY MISSION üîÑ</h4>
                            </div>
                        </div>

                        <!-- Data & Intel Layout -->
                        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            <div class="lg:col-span-8">
                                <h3 class="text-[11px] font-black text-slate-500 tracking-[0.4em] uppercase mb-6 px-4">
                                    DATA RESOLUTION</h3>
                                <div x-init="$watch('segments.length', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) })"
                                    class="bg-black/40 border border-white/5 p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] h-[400px] md:h-[550px] overflow-y-auto text-base md:text-xl leading-relaxed text-slate-300 font-medium pr-4">
                                    <template x-for="seg in segments">
                                        <p class="mb-4 md:mb-6 hover:text-indigo-400 transition-colors cursor-pointer"
                                            x-text="seg.text"></p>
                                    </template>
                                    <p x-show="!segments.length" x-text="transcript"></p>
                                </div>
                            </div>
                            <div class="lg:col-span-4 space-y-6">
                                <h3 class="text-[11px] font-black text-slate-500 tracking-[0.4em] uppercase mb-6 px-4">
                                    FEED ANALYTICS</h3>
                                <div
                                    class="bg-white/5 p-8 rounded-[2.5rem] border border-white/5 hover:bg-white/10 transition-all">
                                    <p class="text-[11px] font-black text-slate-500 mb-2 uppercase tracking-widest">WORD
                                        COUNT</p>
                                    <p class="text-2xl font-black text-white italic"
                                        x-text="Math.round(transcript.split(' ').length)"></p>
                                </div>
                                <div
                                    class="bg-white/5 p-8 rounded-[2.5rem] border border-white/5 hover:bg-white/10 transition-all">
                                    <p class="text-[11px] font-black text-slate-500 mb-2 uppercase tracking-widest">
                                        BIOME REACHED</p>
                                    <p class="text-2xl font-black text-white italic"
                                        x-text="gameScore > 40000 ? 'High-Speed Highway' : (gameScore > 20000 ? 'Deep Ocean Beach' : 'Cyber City Core')">
                                    </p>
                                </div>
                                <div class="bg-indigo-500/10 p-8 rounded-[2.5rem] border border-indigo-500/20">
                                    <p class="text-[11px] font-black text-indigo-400 mb-2 uppercase tracking-widest">
                                        ENGINE HEALTH</p>
                                    <div class="flex items-center gap-2">
                                        <div class="flex-1 h-2 bg-white/5 rounded-full overflow-hidden">
                                            <div class="h-full bg-indigo-500 w-[98%]"></div>
                                        </div>
                                        <span class="text-xs font-black text-indigo-400">98%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="mt-8 text-center text-slate-400 text-xs font-medium uppercase tracking-[0.3em]">
                    Transcribed by SpeechScribe AI & Groq
                </div>
            </div>
        </template>

        <!-- Spinotek Credit -->
        <footer class="mt-auto pt-16 pb-8 text-center">
            <a href="https://spinotek.com" target="_blank"
                class="group inline-flex flex-col items-center gap-3 no-underline transition-all hover:scale-105">
                <div
                    class="flex items-center gap-2 text-[10px] font-black tracking-[0.4em] uppercase text-slate-500 group-hover:text-indigo-400 transition-colors">
                    Made with <span class="text-rose-500 animate-pulse">‚ù§</span> by
                </div>
                <div
                    class="px-8 py-3 bg-white/5 border border-white/10 rounded-2xl backdrop-blur-md group-hover:border-indigo-500/50 group-hover:bg-indigo-500/5 transition-all shadow-2xl">
                    <span
                        class="text-xl font-black tracking-tighter text-white group-hover:gradient-text transition-all">Spinotek.com</span>
                </div>
            </a>
        </footer>
    </div>

    <script>
        function scribeApp() {
            return {
                status: 'idle',
                apiMode: 'system', // 'system' or 'custom'
                groqKey: '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',
                transcript: '',
                copyLabel: 'Salin Teks',
                gameScore: 0,
                gameCoins: 0,
                isManual: false,
                fileName: '',
                audioUrl: null,
                segments: [], // {text: string, start: float, end: float}
                currentTime: 0,
                showResultCard: false,
                processMode: 'auto', // 'auto' (Standard Loading) or 'manual' (Game + Music)
                localStatus: '',
                interimText: '',
                displayedTranscript: '',
                isSyncing: false,
                isPaused: false,
                isMuted: true,
                gameLoopId: null,

                togglePause() {
                    this.isPaused = !this.isPaused;
                },

                isMonitoring: false,
                monitorStream: null,
                monitorRecorder: null,
                monitorVideoTracks: null,
                lastMonitorChunkText: '',
                monitorQueue: [],
                isProcessingQueue: false,




                toggleMute() {
                    this.isMuted = !this.isMuted;
                },

                retryGame() {
                    if (this.gameLoopId) {
                        cancelAnimationFrame(this.gameLoopId);
                        this.gameLoopId = null;
                    }
                    this.gameScore = 0;
                    this.gameCoins = 0;
                    this.status = 'processing';
                    this.isManual = false;
                    this.isPaused = false;
                    this.$nextTick(() => this.initGame());
                },

                async handleFile(e) {
                    const file = e.target.files[0];
                    if (!file || !this.groqKey) {
                        alert("API Key dan File wajib diisi!");
                        return;
                    }
                    this.fileName = file.name;
                    if (this.audioUrl) URL.revokeObjectURL(this.audioUrl);
                    this.audioUrl = URL.createObjectURL(file);
                    if (this.apiMode === 'custom') {
                        localStorage.setItem('groq_key_custom', this.groqKey);
                    }
                    this.status = 'processing';
                    this.isPaused = false;
                    this.transcript = ''; // Reset
                    this.segments = [];
                    this.currentTime = 0;
                    this.showResultCard = true; // Always show result card relative to the center or right

                    if (this.processMode === 'auto') {
                        // AUTO MODE: Uses Groq (Cloud)
                        try {
                            const formData = new FormData();
                            formData.append("file", file);
                            formData.append("model", "whisper-large-v3");
                            formData.append("language", "id");

                            const resp = await fetch("https://api.groq.com/openai/v1/audio/transcriptions", {
                                method: "POST",
                                headers: { "Authorization": `Bearer ${this.groqKey}` },
                                body: formData
                            });

                            const data = await resp.json();
                            if (data.error) throw new Error(data.error.message);

                            this.transcript = data.text;
                            this.isPaused = true;
                            setTimeout(() => window.dispatchEvent(new Event('resize')), 100);
                        } catch (err) {
                            console.error(err);
                            this.transcript = "TRANSCRIPTION ERROR: " + err.message;
                            this.isPaused = true;
                        }
                    } else {
                        // ADVENTURE MODE: Uses Local Library (Simulated / Web Speech API)
                        // No Groq API call here.
                        this.startLocalProcessing();
                    }
                },

                async startLocalProcessing() {
                    // Wait for DOM to render the audio element in the result card
                    this.$nextTick(async () => {
                        const audio = document.querySelector('audio');
                        if (!audio) {
                            console.error("Audio element not found");
                            this.localStatus = 'DOM ERROR: RESTART';
                            return;
                        }

                        this.isSyncing = true;
                        this.transcript = '';
                        this.displayedTranscript = '';
                        this.segments = [];

                        // 1. Play audio immediately
                        audio.play().catch(e => {
                            console.warn("Autoplay blocked", e);
                            this.localStatus = 'TAP PLAY TO START';
                        });

                        // 2. Transcription loop is now handled by Alpine template for better performance
                        const syncInterval = setInterval(() => {
                            if (this.status !== 'processing' && this.status !== 'gameover') {
                                clearInterval(syncInterval);
                            }
                        }, 500);

                        // 3. Background Groq Fetch
                        try {
                            const formData = new FormData();
                            const blob = await fetch(this.audioUrl).then(r => r.blob());
                            formData.append("file", new File([blob], "audio.mp3"));
                            formData.append("model", "whisper-large-v3");
                            formData.append("response_format", "verbose_json");
                            formData.append("timestamp_granularities[]", "word");

                            const resp = await fetch("https://api.groq.com/openai/v1/audio/transcriptions", {
                                method: "POST",
                                headers: { "Authorization": `Bearer ${this.groqKey}` },
                                body: formData
                            });

                            const data = await resp.json();
                            if (data.words) {
                                // Use precise word-level timestamps from Groq
                                this.segments = data.words.map(w => ({
                                    start: w.start,
                                    text: w.word
                                }));
                                this.transcript = data.text;
                                this.localStatus = 'SYNC COMPLETE';
                            } else if (data.segments) {
                                // Fallback to segment-level with better estimation
                                let allWords = [];
                                data.segments.forEach(seg => {
                                    const words = seg.text.trim().split(/\s+/);
                                    if (words.length === 0) return;

                                    const duration = seg.end - seg.start;
                                    // Add a small 0.1s buffer to avoid appearing exactly at the start
                                    const startOffset = seg.start + 0.1;
                                    const wordDuration = (duration - 0.2) / words.length;

                                    words.forEach((w, i) => {
                                        allWords.push({
                                            start: startOffset + (i * wordDuration),
                                            text: w
                                        });
                                    });
                                });
                                this.segments = allWords;
                                this.transcript = data.text;
                                this.localStatus = 'SYNC COMPLETE';
                            } else if (data.text) {
                                // Fallback if no segments: estimate based on duration
                                const words = data.text.split(' ');
                                const totalDuration = audio.duration || 60;
                                const wordDuration = totalDuration / words.length;
                                this.segments = words.map((w, i) => ({
                                    start: i * wordDuration,
                                    text: w
                                }));
                                this.transcript = data.text;
                            }
                        } catch (err) {
                            console.error("Sync Error:", err);
                            this.localStatus = 'SYNC FAILED';
                        } finally {
                            this.isSyncing = false;
                        }
                    });
                },

                async startMonitoring() {
                    if (!this.groqKey) {
                        alert("API Key wajib diisi!");
                        return;
                    }

                    try {
                        const fullStream = await navigator.mediaDevices.getDisplayMedia({
                            video: true,
                            audio: true
                        });

                        const audioTracks = fullStream.getAudioTracks();
                        if (audioTracks.length === 0) {
                            fullStream.getTracks().forEach(t => t.stop());
                            alert("Sistem tidak mendeteksi audio. Harap pilih 'Tab' atau 'Seluruh Layar' DAN centang 'Sertakan audio sistem'!");
                            return;
                        }

                        // Use only audio tracks for the recorder to avoid video/audio mismatch errors
                        this.monitorStream = new MediaStream(audioTracks);
                        this.monitorVideoTracks = fullStream.getVideoTracks();

                        this.status = 'monitoring';
                        this.isMonitoring = true;
                        this.transcript = '';
                        this.segments = [];
                        this.showResultCard = true;
                        this.fileName = "Live Monitoring Session";
                        this.audioUrl = null;


                        this.startMonitorChunks();

                        this.monitorVideoTracks[0].onended = () => this.stopMonitoring();

                    } catch (err) {
                        console.error("Monitor Error:", err);
                        alert("Gagal memulai monitoring: " + err.message);
                    }
                },

                startMonitorChunks() {
                    let chunks = [];
                    const mimeTypes = [
                        'audio/webm;codecs=opus',
                        'audio/webm',
                        'audio/ogg;codecs=opus',
                        'audio/mp4'
                    ];
                    let selectedType = '';
                    for (const type of mimeTypes) {
                        if (MediaRecorder.isTypeSupported(type)) {
                            selectedType = type;
                            break;
                        }
                    }

                    try {
                        this.monitorRecorder = new MediaRecorder(this.monitorStream, selectedType ? { mimeType: selectedType } : {});
                    } catch (e) {
                        console.error("Recorder Error:", e);
                        alert("Browser gagal memulai recorder: " + e.message);
                        this.stopMonitoring();
                        return;
                    }

                    this.monitorRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) chunks.push(e.data);
                    };

                    this.monitorRecorder.onstop = () => {
                        if (chunks.length > 0) {
                            const blob = new Blob(chunks, { type: selectedType || 'audio/webm' });
                            chunks = [];

                            // Restart immediately to avoid silence gaps
                            if (this.isMonitoring) {
                                try {
                                    this.monitorRecorder.start();
                                    setTimeout(() => {
                                        if (this.isMonitoring && this.monitorRecorder.state === 'recording') {
                                            this.monitorRecorder.stop();
                                        }
                                    }, 10000); // Use 10s chunks for better accuracy
                                } catch (err) { console.error("Auto-restart failed", err); }
                            }

                            // Push to queue for sequential processing (prevent request stacking)
                            this.monitorQueue.push(blob);
                            this.processMonitorQueue();
                        }
                    };

                    this.monitorRecorder.start();
                    setTimeout(() => {
                        if (this.isMonitoring && this.monitorRecorder.state === 'recording') {
                            this.monitorRecorder.stop();
                        }
                    }, 10000); // initial 10s chunk
                },


                async processMonitorQueue() {
                    if (this.isProcessingQueue || this.monitorQueue.length === 0) return;
                    this.isProcessingQueue = true;

                    const blob = this.monitorQueue.shift();
                    let retryCount = 0;
                    const maxRetries = 3;

                    const attemptTranscribe = async () => {
                        try {
                            const formData = new FormData();
                            formData.append("file", new File([blob], "chunk.m4a"));
                            formData.append("model", "whisper-large-v3");
                            formData.append("language", "id");

                            const basePrompt = "Transkrip langsung dari audio sistem. Abaikan suara hening atau noise.";
                            const contextContent = this.lastMonitorChunkText ?
                                (this.lastMonitorChunkText.slice(-150) + ". " + basePrompt) : basePrompt;
                            formData.append("prompt", contextContent);

                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 25000); // Increased timeout to 25s

                            const resp = await fetch("https://api.groq.com/openai/v1/audio/transcriptions", {
                                method: "POST",
                                headers: { "Authorization": `Bearer ${this.groqKey}` },
                                body: formData,
                                signal: controller.signal
                            });
                            clearTimeout(timeoutId);

                            if (!resp.ok) {
                                if (resp.status === 429 && retryCount < maxRetries) {
                                    console.warn("Rate limited. Retrying...");
                                    throw new Error("rate_limit");
                                }
                                throw new Error(`HTTP_${resp.status}`);
                            }

                            const data = await resp.json();
                            if (data.text && data.text.trim()) {
                                let resultText = data.text.trim();

                                // Hallucination filter
                                const hallucinations = [
                                    "terima kasih", "terima kasih telah menonton", "terima kasih sudah menonton",
                                    "nonton terus ya", "subtitles by", "transcribed by", "thank you",
                                    "thank you for watching", "don't forget to subscribe", "jangan lupa subscribe",
                                    "bye bye", "sampai jumpa", "thank you very much", "please subscribe",
                                    "like and subscribe", "nonton terus", "see you soon"
                                ];
                                const cleanText = resultText.replace(/[.,!]/g, '').toLowerCase().trim();
                                const isHallucination = hallucinations.some(h => {
                                    const cleanH = h.toLowerCase().trim();
                                    return cleanText === cleanH || (cleanText.length < 40 && cleanText.includes(cleanH));
                                });
                                const isNoise = cleanText.length <= 1 || (cleanText.length < 5 && !/[aeiouy]/.test(cleanText));

                                if (!isHallucination && !isNoise) {
                                    if (this.lastMonitorChunkText) {
                                        const prevWords = this.lastMonitorChunkText.toLowerCase().split(/\s+/).slice(-5);
                                        const currWords = resultText.toLowerCase().split(/\s+/);
                                        let overlapLen = 0;
                                        for (let i = Math.min(prevWords.length, currWords.length); i > 0; i--) {
                                            if (prevWords.slice(-i).join(" ") === currWords.slice(0, i).join(" ")) { overlapLen = i; break; }
                                        }
                                        if (overlapLen > 0) resultText = resultText.split(/\s+/).slice(overlapLen).join(" ");
                                    }

                                    if (resultText.trim()) {
                                        this.lastMonitorChunkText = (this.lastMonitorChunkText + " " + resultText).slice(-500);
                                        const words = resultText.trim().split(/\s+/);
                                        let wordDelay = 0;
                                        words.forEach((word, index) => {
                                            setTimeout(() => {
                                                if (!this.isMonitoring && this.status !== 'complete') return;
                                                this.segments.push({ text: word + ' ', start: 0 });
                                                if (index === 0 && this.transcript && !this.transcript.endsWith(" ")) this.transcript += " ";
                                                this.transcript += word + (index < words.length - 1 ? " " : "");
                                            }, wordDelay);
                                            wordDelay += 80;
                                        });
                                    }
                                }
                            }
                        } catch (err) {
                            if ((err.name === 'AbortError' || err.message === 'rate_limit') && retryCount < maxRetries) {
                                retryCount++;
                                const waitTime = retryCount * 2000; // 2s, 4s, 6s backoff
                                console.log(`Attempt ${retryCount} failed. Waiting ${waitTime}ms...`);
                                await new Promise(r => setTimeout(r, waitTime));
                                return attemptTranscribe();
                            }
                            console.error("Queue Processing Error:", err);
                        }
                    };

                    await attemptTranscribe();
                    this.isProcessingQueue = false;
                    this.processMonitorQueue(); // Next in queue
                },




                stopMonitoring() {
                    this.isMonitoring = false;
                    if (this.monitorRecorder && this.monitorRecorder.state !== 'inactive') {
                        this.monitorRecorder.stop();
                    }
                    if (this.monitorStream) {
                        this.monitorStream.getTracks().forEach(track => track.stop());
                    }
                    this.status = 'complete';
                },

                initGame() {
                    if (this.processMode === 'auto') return;
                    if (this.gameLoopId) cancelAnimationFrame(this.gameLoopId);

                    this.$nextTick(() => {
                        const container = document.getElementById('gameCanvas').parentElement;
                        const canvas = document.getElementById('gameCanvas');
                        if (!canvas) return;

                        const scene = new THREE.Scene();
                        const camera = new THREE.PerspectiveCamera(75, canvas.offsetWidth / canvas.offsetHeight, 0.1, 1000);
                        camera.position.set(0, 7, 13);
                        camera.lookAt(0, 1, -5);

                        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
                        renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
                        renderer.setPixelRatio(window.devicePixelRatio);

                        const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
                        scene.add(ambientLight);
                        const sunLight = new THREE.DirectionalLight(0xfff7ed, 1.8);
                        sunLight.position.set(10, 20, 10);
                        scene.add(sunLight);

                        // AUDIO SYSTEM
                        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                        const playSound = (freq, type, duration, vol = 0.1) => {
                            if (this.isMuted) return; // Honor mute setting
                            const osc = audioCtx.createOscillator();
                            const gain = audioCtx.createGain();
                            osc.type = type;
                            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                            osc.connect(gain);
                            gain.connect(audioCtx.destination);
                            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                            osc.start();
                            osc.stop(audioCtx.currentTime + duration);
                        };

                        const playCoinSound = () => playSound(880, 'triangle', 0.2);
                        const playCrashSound = () => playSound(100, 'sawtooth', 0.5, 0.2);
                        const playJumpSound = () => playSound(440, 'sine', 0.1);

                        let bgmInterval = setInterval(() => {
                            if ((this.status === 'processing' || this.status === 'gameover') && !this.isPaused) {
                                playSound(110 + (currentBiomeIdx * 20), 'sine', 0.1, 0.05);
                            }
                        }, 500);

                        const BIOMES = [
                            { name: 'city', bg: 0xbae6fd, ground: 0x64748b, sides: 0x22c55e, type: 'run', obsName: 'Box' },
                            { name: 'beach', bg: 0x7dd3fc, ground: 0xfef08a, sides: 0x0ea5e9, type: 'run', obsName: 'Sphere' },
                            { name: 'desert', bg: 0xfdba74, ground: 0xd97706, sides: 0xb45309, type: 'bike', obsName: 'Dodecahedron' },
                            { name: 'highway', bg: 0x1e293b, ground: 0x334155, sides: 0x0f172a, type: 'car', obsName: 'Cone' }
                        ];

                        let currentBiomeIdx = 0;
                        const updateBiomeVisuals = (idx) => {
                            const b = BIOMES[idx];
                            scene.background = new THREE.Color(b.bg);
                            scene.fog = new THREE.FogExp2(b.bg, 0.02);
                            roadMat.color.set(b.ground);
                            grassMat.color.set(b.sides);
                        };

                        const roadGeom = new THREE.PlaneGeometry(10, 2000);
                        const roadMat = new THREE.MeshPhongMaterial({ color: BIOMES[0].ground });
                        const road = new THREE.Mesh(roadGeom, roadMat);
                        road.rotation.x = -Math.PI / 2;
                        scene.add(road);

                        // ROAD MARKINGS
                        const lineGeom = new THREE.PlaneGeometry(0.2, 2);
                        const lineMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                        const roadLines = [];
                        for (let i = 0; i < 50; i++) {
                            [-1.65, 1.65].forEach(x => {
                                const line = new THREE.Mesh(lineGeom, lineMat);
                                line.rotation.x = -Math.PI / 2;
                                line.position.set(x, 0.01, -i * 10);
                                scene.add(line);
                                roadLines.push(line);
                            });
                        }

                        const grassMat = new THREE.MeshPhongMaterial({ color: BIOMES[0].sides });
                        [-30, 30].forEach(x => {
                            const g = new THREE.Mesh(new THREE.PlaneGeometry(50, 1000), grassMat);
                            g.rotation.x = -Math.PI / 2;
                            g.position.set(x, -0.01, 0);
                            scene.add(g);
                        });

                        const props = [];
                        const spawnProp = (zPos) => {
                            const biome = BIOMES[currentBiomeIdx].name;
                            [-1, 1].forEach(side => {
                                const group = new THREE.Group();
                                if (biome === 'city') {
                                    const w = 6 + Math.random() * 4;
                                    const d = 6 + Math.random() * 4;
                                    const h = 15 + Math.random() * 25;
                                    const body = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshPhongMaterial({ color: 0x1e293b }));
                                    body.position.y = h / 2;
                                    group.add(body);

                                    // Windows
                                    for (let r = 1; r < (h / 2); r++) {
                                        for (let c = 0; c < 3; c++) {
                                            const win = new THREE.Mesh(new THREE.PlaneGeometry(0.5, 0.5), new THREE.MeshBasicMaterial({ color: 0xfacc15, transparent: true, opacity: 0.8 }));
                                            win.position.set(-w / 2 - 0.01, r * 2, (c - 1) * 2);
                                            win.rotation.y = -Math.PI / 2;
                                            group.add(win);
                                        }
                                    }

                                    // Antennas
                                    if (Math.random() > 0.5) {
                                        const ant = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 4), new THREE.MeshPhongMaterial({ color: 0x475569 }));
                                        ant.position.set(0, h + 2, 0);
                                        group.add(ant);
                                    }
                                } else if (biome === 'beach') {
                                    // Beach Umbrellas
                                    const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 3), new THREE.MeshPhongMaterial({ color: 0x94a3b8 }));
                                    pole.position.y = 1.5; group.add(pole);
                                    const top = new THREE.Mesh(new THREE.ConeGeometry(2, 1, 8), new THREE.MeshPhongMaterial({ color: Math.random() > 0.5 ? 0xef4444 : 0x3b82f6 }));
                                    top.position.y = 3; group.add(top);
                                } else if (biome === 'desert') {
                                    // Cacti
                                    const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 2.5, 8), new THREE.MeshPhongMaterial({ color: 0x15803d }));
                                    body.position.y = 1.25; group.add(body);
                                    const arm1 = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1), new THREE.MeshPhongMaterial({ color: 0x15803d }));
                                    arm1.position.set(0.4, 1.5, 0); arm1.rotation.z = 0.5; group.add(arm1);
                                    const arm2 = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.2, 1), new THREE.MeshPhongMaterial({ color: 0x15803d }));
                                    arm2.position.set(-0.4, 2, 0); arm2.rotation.z = -0.5; group.add(arm2);
                                } else if (biome === 'highway') {
                                    const pole = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, 10), new THREE.MeshPhongMaterial({ color: 0x475569 })); pole.position.y = 5; group.add(pole);
                                }
                                group.position.set(side * (12 + Math.random() * 15), 0, zPos);
                                scene.add(group); props.push(group);
                            });
                        };
                        for (let i = 0; i < 40; i++) spawnProp(-i * 12);

                        const charGroup = new THREE.Group();
                        charGroup.position.z = 5;
                        scene.add(charGroup);

                        const runner = new THREE.Group();
                        const torso = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.8, 0.4), new THREE.MeshPhongMaterial({ color: 0x6366f1 })); torso.position.y = 1.6; runner.add(torso);
                        const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), new THREE.MeshPhongMaterial({ color: 0xffdbac })); head.position.y = 2.2; runner.add(head);
                        const lArm = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.7, 0.2), new THREE.MeshPhongMaterial({ color: 0x6366f1 })); lArm.position.set(-0.4, 1.6, 0); runner.add(lArm);
                        const rArm = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.7, 0.2), new THREE.MeshPhongMaterial({ color: 0x6366f1 })); rArm.position.set(0.4, 1.6, 0); runner.add(rArm);
                        const lLeg = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.8, 0.25), new THREE.MeshPhongMaterial({ color: 0x1e1b4b })); lLeg.position.set(-0.2, 0.8, 0); runner.add(lLeg);
                        const rLeg = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.8, 0.25), new THREE.MeshPhongMaterial({ color: 0x1e1b4b })); rLeg.position.set(0.2, 0.8, 0); runner.add(rLeg);
                        charGroup.add(runner);

                        const bike = new THREE.Group();
                        const bikeFrame = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.4, 1.2), new THREE.MeshPhongMaterial({ color: 0xef4444 })); bikeFrame.position.y = 0.8; bike.add(bikeFrame);
                        const bWheelGeom = new THREE.CylinderGeometry(0.4, 0.4, 0.2, 16); const bWheelMat = new THREE.MeshPhongMaterial({ color: 0x333333 });
                        const frontWheel = new THREE.Mesh(bWheelGeom, bWheelMat); frontWheel.rotation.z = Math.PI / 2; frontWheel.position.set(0, 0.4, -0.8); bike.add(frontWheel);
                        const backWheel = new THREE.Mesh(bWheelGeom, bWheelMat); backWheel.rotation.z = Math.PI / 2; backWheel.position.set(0, 0.4, 0.8); bike.add(backWheel);
                        const handlebars = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 1.2), new THREE.MeshPhongMaterial({ color: 0x222222 })); handlebars.rotation.z = Math.PI / 2; handlebars.position.set(0, 1.4, -0.5); bike.add(handlebars);
                        const barStem = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, 0.8), new THREE.MeshPhongMaterial({ color: 0x222222 })); barStem.position.set(0, 1.0, -0.5); barStem.rotation.x = 0.2; bike.add(barStem);
                        const seat = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.1, 0.6), new THREE.MeshPhongMaterial({ color: 0x111111 })); seat.position.set(0, 1.0, 0.2); bike.add(seat);
                        bike.visible = false; charGroup.add(bike);

                        const car = new THREE.Group();
                        const carBody = new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.6, 3), new THREE.MeshPhongMaterial({ color: 0x10b981 })); carBody.position.y = 0.6; car.add(carBody);
                        const carTop = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.6, 1.5), new THREE.MeshPhongMaterial({ color: 0x064e3b })); carTop.position.set(0, 1.2, -0.2); car.add(carTop);
                        const wheelGeom = new THREE.CylinderGeometry(0.3, 0.3, 0.4, 12); const wheelMat = new THREE.MeshPhongMaterial({ color: 0x111111 });
                        [[-0.8, 0.3, 1], [0.8, 0.3, 1], [-0.8, 0.3, -1], [0.8, 0.3, -1]].forEach(pos => {
                            const w = new THREE.Mesh(wheelGeom, wheelMat); w.rotation.z = Math.PI / 2; w.position.set(...pos); car.add(w);
                        });
                        const lightGeom = new THREE.BoxGeometry(0.4, 0.2, 0.1); const lightMat = new THREE.MeshPhongMaterial({ color: 0xffff00, emissive: 0xffff00 });
                        [[-0.5, 0.6, 1.5], [0.5, 0.6, 1.5]].forEach(pos => {
                            const l = new THREE.Mesh(lightGeom, lightMat); l.position.set(...pos); car.add(l);
                        });
                        const windowGeom = new THREE.PlaneGeometry(1.2, 0.4); const windowMat = new THREE.MeshPhongMaterial({ color: 0x88ccff, transparent: true, opacity: 0.6 });
                        const frontWin = new THREE.Mesh(windowGeom, windowMat); frontWin.position.set(0, 1.2, 0.56); car.add(frontWin);
                        car.visible = false; charGroup.add(car);

                        let lane = 0;
                        const laneWidth = 3.3;
                        let gameSpeed = 0.7;
                        let obstacles = [];
                        let coins = [];
                        let frame = 0;
                        let currentSpawnLane = -99;

                        updateBiomeVisuals(0);

                        const handleInput = (dir) => {
                            if (this.isPaused || this.status === 'gameover') return;
                            this.isManual = true;
                            if (dir === 'left' && lane > -1) lane--;
                            if (dir === 'right' && lane < 1) lane++;
                            playJumpSound();
                            gsap.to(charGroup.position, { x: lane * laneWidth, duration: 0.15 });
                        };

                        // Cleanup previous listeners to avoid duplicates
                        if (window._scribeKeyHandler) window.removeEventListener('keydown', window._scribeKeyHandler);
                        if (window._scribeClickHandler && canvas._prevHandler) {
                            canvas.removeEventListener('mousedown', canvas._prevHandler);
                        }

                        window._scribeKeyHandler = (e) => {
                            const key = e.key.toLowerCase();
                            if (key === 'arrowleft' || key === 'a') handleInput('left');
                            if (key === 'arrowright' || key === 'd') handleInput('right');
                        };
                        const clickHandler = (e) => {
                            const rect = canvas.getBoundingClientRect();
                            if ((e.clientX - rect.left) < rect.width / 2) handleInput('left');
                            else handleInput('right');
                        };
                        canvas._prevHandler = clickHandler;

                        window.addEventListener('keydown', window._scribeKeyHandler);
                        canvas.addEventListener('mousedown', clickHandler);

                        const animate = () => {
                            if (this.status === 'complete' || this.status === 'idle') {
                                clearInterval(bgmInterval);
                                return;
                            }
                            if (this.isPaused || this.status === 'gameover') {
                                renderer.render(scene, camera);
                                this.gameLoopId = requestAnimationFrame(animate);
                                return;
                            }

                            const targetIdx = Math.floor(this.gameScore / 20000) % BIOMES.length;
                            if (targetIdx !== currentBiomeIdx) {
                                currentBiomeIdx = targetIdx;
                                const flash = document.getElementById('gameFlash');
                                if (flash) { flash.style.opacity = '1'; setTimeout(() => { updateBiomeVisuals(currentBiomeIdx); flash.style.opacity = '0'; }, 150); }
                                bike.visible = BIOMES[currentBiomeIdx].type === 'bike';
                                car.visible = BIOMES[currentBiomeIdx].type === 'car';
                                runner.visible = BIOMES[currentBiomeIdx].type === 'run' || BIOMES[currentBiomeIdx].type === 'bike';
                                if (BIOMES[currentBiomeIdx].type === 'run') {
                                    torso.position.y = 1.6; head.position.y = 2.2;
                                    lArm.position.set(-0.4, 1.6, 0); rArm.position.set(0.4, 1.6, 0);
                                    lLeg.position.set(-0.2, 0.8, 0); rLeg.position.set(0.2, 0.8, 0);
                                } else if (BIOMES[currentBiomeIdx].type === 'bike') {
                                    torso.position.y = 1.1; head.position.y = 1.7;
                                    lArm.position.set(-0.4, 1.3, -0.3); rArm.position.set(0.4, 1.3, -0.3);
                                    lLeg.position.set(-0.2, 0.5, 0); rLeg.position.set(0.2, 0.5, 0);
                                    lArm.rotation.x = -Math.PI / 1.5; rArm.rotation.x = -Math.PI / 1.5;
                                    lLeg.rotation.x = Math.PI / 4; rLeg.rotation.x = Math.PI / 4;
                                } else { runner.visible = false; }
                                // Adjust game speed slightly per loop
                                gameSpeed = 0.7 + (Math.floor(this.gameScore / (20000 * BIOMES.length)) * 0.05);
                            }

                            const mode = BIOMES[currentBiomeIdx].type;
                            const runCycle = frame * 0.15;
                            if (mode === 'run') {
                                lArm.rotation.x = Math.sin(runCycle) * 0.8; rArm.rotation.x = -Math.sin(runCycle) * 0.8;
                                lLeg.rotation.x = -Math.sin(runCycle) * 0.8; rLeg.rotation.x = Math.sin(runCycle) * 0.8;
                                charGroup.position.y = Math.abs(Math.cos(runCycle * 2)) * 0.15;
                            } else if (mode === 'bike') {
                                charGroup.position.y = Math.sin(frame * 0.2) * 0.05;
                                // Handlebars shake slightly
                                bike.rotation.y = Math.sin(frame * 0.4) * 0.02;
                                lArm.rotation.x = -Math.PI / 3 + Math.sin(frame * 0.4) * 0.05;
                                rArm.rotation.x = -Math.PI / 3 + Math.sin(frame * 0.4) * 0.05;
                            } else if (mode === 'car') {
                                charGroup.position.y = Math.sin(frame * 0.3) * 0.02;
                            }

                            props.forEach(p => {
                                p.position.z += gameSpeed;
                                if (p.position.z > 20) p.position.z = -250;
                            });

                            roadLines.forEach(l => {
                                l.position.z += gameSpeed;
                                if (l.position.z > 20) l.position.z -= 500;
                            });

                            // Move and check collisions (Backwards to safely splice)
                            for (let i = obstacles.length - 1; i >= 0; i--) {
                                const o = obstacles[i];
                                o.mesh.position.z += gameSpeed;

                                // Collision Detection
                                if (Math.abs(o.mesh.position.z - charGroup.position.z) < 1.4 && o.lane === lane) {
                                    playCrashSound();
                                    this.status = 'gameover';
                                }

                                // Cleanup
                                if (o.mesh.position.z > 20) {
                                    scene.remove(o.mesh);
                                    obstacles.splice(i, 1);
                                }
                            }

                            coins.forEach((c, i) => {
                                c.mesh.position.z += gameSpeed;
                                c.mesh.rotation.y += 0.1;
                                if (Math.abs(c.mesh.position.z - charGroup.position.z) < 1.5 && c.lane === lane) {
                                    playCoinSound(); this.gameScore += 1000; this.gameCoins++;
                                    scene.remove(c.mesh); coins.splice(i, 1);
                                } else if (c.mesh.position.z > 20) { scene.remove(c.mesh); coins.splice(i, 1); }
                            });

                            if (!this.isManual) {
                                // Pro-Level Auto-Pilot
                                const reactionDistance = 60 + (gameSpeed * 100);

                                // Evaluate all lanes
                                const laneScores = [-1, 0, 1].map(l => {
                                    // Filter obstacles that are in front OR currently colliding
                                    const upcoming = obstacles.filter(o => o.lane === l && o.mesh.position.z < 8);

                                    let dist = 1000;
                                    if (upcoming.length > 0) {
                                        // Find the closest one
                                        const closest = upcoming.reduce((prev, curr) =>
                                            Math.abs(curr.mesh.position.z - charGroup.position.z) < Math.abs(prev.mesh.position.z - charGroup.position.z) ? curr : prev
                                        );
                                        dist = Math.abs(closest.mesh.position.z - charGroup.position.z);

                                        // If it already passed but is still in hit zone, treat as "extremely dangerous"
                                        if (closest.mesh.position.z > charGroup.position.z) dist *= 0.1;
                                    }

                                    const hasCoin = coins.some(c => c.lane === l && Math.abs(c.mesh.position.z - charGroup.position.z) < 40);

                                    return {
                                        lane: l,
                                        dist: dist,
                                        score: dist + (hasCoin ? 15 : 0)
                                    };
                                });

                                // Stable lane selection: Only switch if the other lane is significantly better
                                // or if the current lane is genuinely blocked.
                                laneScores.sort((a, b) => b.score - a.score);

                                const currentLaneData = laneScores.find(d => d.lane === lane);
                                const topChoice = laneScores[0];

                                let shouldSwitch = false;
                                if (currentLaneData.dist < reactionDistance) {
                                    // Current lane is dangerous
                                    if (topChoice.lane !== lane) shouldSwitch = true;
                                } else if (topChoice.score > currentLaneData.score + 30) {
                                    // Another lane is much better (coins or much clearer)
                                    shouldSwitch = true;
                                }

                                if (shouldSwitch) {
                                    lane = topChoice.lane;
                                    gsap.to(charGroup.position, {
                                        x: lane * laneWidth,
                                        duration: 0.08, // Faster dodge
                                        ease: "expo.out"
                                    });
                                }
                            }

                            if (frame % 80 === 0) {
                                const l = Math.floor(Math.random() * 3) - 1;
                                currentSpawnLane = l;
                                const type = BIOMES[currentBiomeIdx].obsName;
                                let geom;
                                if (type === 'Sphere') geom = new THREE.SphereGeometry(1, 12, 12);
                                else if (type === 'Dodecahedron') geom = new THREE.DodecahedronGeometry(1.2);
                                else if (type === 'Cone') geom = new THREE.ConeGeometry(0.8, 2, 8);
                                else geom = new THREE.BoxGeometry(2, 1.5, 1.5);
                                const o = new THREE.Mesh(geom, new THREE.MeshPhongMaterial({ color: 0xef4444 }));
                                o.position.set(l * laneWidth, 0.75, -120); scene.add(o); obstacles.push({ mesh: o, lane: l });
                            }

                            if (frame % 60 === 0) {
                                let l = Math.floor(Math.random() * 3) - 1;
                                if (l === currentSpawnLane) l = (l === 1) ? -1 : l + 1;
                                const c = new THREE.Mesh(new THREE.TorusGeometry(0.4, 0.1, 8, 16), new THREE.MeshPhongMaterial({ color: 0xfacc15, emissive: 0x444400 }));
                                c.position.set(l * laneWidth, 1.2, -120); scene.add(c); coins.push({ mesh: c, lane: l });
                            }

                            frame++;
                            this.gameScore += Math.floor(gameSpeed * 20);
                            renderer.render(scene, camera);
                            this.gameLoopId = requestAnimationFrame(animate);
                        };
                        animate();
                        window.addEventListener('resize', () => {
                            camera.aspect = canvas.offsetWidth / canvas.offsetHeight; camera.updateProjectionMatrix();
                            renderer.setSize(canvas.offsetWidth, canvas.offsetHeight);
                        });
                    });
                },

                togglePause() { this.isPaused = !this.isPaused; },
                reset() {
                    if (this.isMonitoring) this.stopMonitoring();
                    if (this.audioUrl) URL.revokeObjectURL(this.audioUrl);
                    this.status = 'idle'; this.transcript = ''; this.displayedTranscript = ''; this.gameScore = 0; this.gameCoins = 0; this.isManual = false; this.isPaused = false; this.showGameFinish = false; this.fileName = ''; this.audioUrl = null;
                    this.segments = []; this.currentTime = 0; this.showResultCard = false;
                    this.localStatus = ''; this.isSyncing = false; this.isMuted = false;
                    this.lastMonitorChunkText = '';
                    this.monitorQueue = [];
                    this.isProcessingQueue = false;
                },


                copyToClipboard() {
                    navigator.clipboard.writeText(this.transcript);
                    this.copyLabel = 'Tersalin! ‚úÖ';
                    setTimeout(() => this.copyLabel = 'Salin Teks', 2000);
                }
            }
        }
    </script>
</body>

</html>
